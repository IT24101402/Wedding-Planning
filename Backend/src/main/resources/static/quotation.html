<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Quotation Page</title>
    <link rel="stylesheet" href="quotation.css">
</head>
<body>
<h1>Quotation Page</h1>
<h2 id="customerName" class="customer-name"></h2>

<div class="card">
    <table>
        <thead>
        <tr>
            <th>Vendor</th>
            <th>Service</th>
            <th>Price</th>
            <th>Actions</th>
        </tr>
        </thead>
        <tbody id="quotationTableBody">
        <!-- Rows will be dynamically inserted here -->
        </tbody>
    </table>
    <div class="total" id="totalAmount">Total: $0</div>
</div>

<button class="finalize-btn">Finalize Quotation</button>

<script>
    async function loadQuotation() {
        const username = sessionStorage.getItem('loggedInUser');
        document.getElementById('customerName').innerText = `Customer Name: ${username}`;
        const res = await fetch(`http://localhost:8080/billing/quotationByUser?username=${username}`);
        const data = await res.json();

        const tableBody = document.getElementById('quotationTableBody');
        tableBody.innerHTML = '';
        let total = 0;

        data.bookings.forEach((b, i) => {
            if (b.customerName === username) {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${b.vendorName}</td>
                    <td>${b.serviceType}</td>
                    <td>${b.price}</td>
                    <td><button onclick="removeBooking(${i})">Delete</button></td>
                `;
                tableBody.appendChild(row);
                total += b.price;
            }
        });

        document.getElementById('totalAmount').innerText = `Total: ${total}`;
    }

    async function removeBooking(index) {
        await fetch(`http://localhost:8080/billing/removeBooking/${index}`, { method: 'DELETE' });
        loadQuotation();
    }

    async function finalize() {
    await fetch('http://localhost:8080/billing/finalize', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ username: sessionStorage.getItem('loggedInUser') })
    });

    // Go to the final bill page
    window.location.href = 'finalBill.html';
}

    document.querySelector('.finalize-btn').addEventListener('click', finalize);

    loadQuotation();
</script>
</body>

</html>
