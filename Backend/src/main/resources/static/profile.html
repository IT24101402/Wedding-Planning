<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Profile - Wedding Planner</title>
</head>
<body style="margin:0; padding:0; background: #f7f7f7; font-family: Arial, Helvetica, sans-serif;">
<div class="profile-container" style="max-width: 400px; margin: 60px auto; background: #fff; border-radius: 12px; box-shadow: 0 2px 16px rgba(0,0,0,0.08); padding: 36px 30px 24px 30px;">
    <h2 style="text-align: center; color: #2d3e50; margin-bottom: 28px;">Update Profile</h2>
    <form id="updateForm" style="display: flex; flex-direction: column; gap: 15px;">
        <label for="username">Username</label>
        <input type="text" id="username" name="username" readonly style="padding: 9px 12px; border: 1px solid #c0c0c0; border-radius: 5px; background: #f1f1f1; color: #888;">

        <label for="email">Email</label>
        <input type="email" id="email" name="email" required>

        <label for="phone">Phone</label>
        <input type="text" id="phone" name="phone" required>

        <label for="password">New Password</label>
        <input type="password" id="password" name="password">

        <button type="submit" style="margin-top: 12px; padding: 10px 0; background: #315fa7; color: #fff; border: none; border-radius: 5px; font-size: 16px;">Save Changes</button>
    </form>
    <p style="margin-top: 20px;">
        <a href="dashboard.html">Back to Dashboard</a> |
        <a href="login.html">Logout</a>
    </p>
</div>

<script>
    window.onload = async function () {
        const loggedInUser = sessionStorage.getItem("loggedInUser");
        console.log("[LOG] Session loggedInUser: ", loggedInUser);

        if (!loggedInUser) {
            alert("You are not logged in.");
            window.location.href = "login.html";
            return;
        }

        try {
            const url = "http://localhost:8080/api/users/user/profile?username=" + encodeURIComponent(loggedInUser);
            console.log("[LOG] Fetching user profile from: ", url);

            const res = await fetch(url);
            console.log("[LOG] Response status: ", res.status);

            if (!res.ok) throw new Error("User not found or server error");

            const data = await res.json();
            console.log("[LOG] User data received: ", data);

            document.getElementById("username").value = data.username;
            document.getElementById("email").value = data.email;
            document.getElementById("phone").value = data.phone;
            document.getElementById("password").value = data.password;

        } catch (err) {
            console.error("[ERROR] Failed to load profile data: ", err);
            alert("❌ Could not load user profile.");
        }
    };

    document.getElementById("updateForm").addEventListener("submit", async function (e) {
        e.preventDefault();

        const updatedUser = {
            username: document.getElementById("username").value.trim(),
            email: document.getElementById("email").value.trim(),
            phone: document.getElementById("phone").value.trim(),
            password: document.getElementById("password").value.trim()
        };

        console.log("[LOG] Sending updated user data: ", updatedUser);

        try {
            const res = await fetch("http://localhost:8080/api/users/update", {
                method: "PUT",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(updatedUser)
            });

            const message = await res.text();
            console.log("[LOG] Update response status: ", res.status);
            console.log("[LOG] Update response message: ", message);

            if (res.ok) {
                alert("✅ " + message);
                sessionStorage.setItem("loggedInUser", updatedUser.username);
                window.location.href = "dashboard.html";
            } else {
                alert("❌ " + message);
            }

        } catch (err) {
            console.error("[ERROR] Failed to update profile: ", err);
            alert("❌ Failed to update profile.");
        }
    });
</script>
</body>
</html>